!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("util"),require("rxjs"),require("dexie"),require("rxjs/operators"),require("rxjs/internal/util/noop")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","@angular/common/http","util","rxjs","dexie","rxjs/operators","rxjs/internal/util/noop"],t):t(e["ngx-jsonapi"]={},e.ng.core,e.common,e.http,e.util,e.rxjs,e.Dexie,e.operators,e.noop)}(this,function(e,i,t,s,o,a,n,c,u){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n;var r,d=(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),p=function(n,r){var i,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},l=function(){this.number=1,this.total_resources=0,this.size=0,this.resources_per_page=0},h=(f.propagateLoaded=function(e,t){for(var n in e){var r=e[n];r instanceof E&&r.setLoaded(t&&r.builded)}},f);function f(){}var v=(g.prototype.applyParams=function(e,t){if(void 0===t&&(t={}),this.appendPath(e.getPrePath()),t.beforepath&&this.appendPath(t.beforepath),this.appendPath(e.getPath()),t.include&&this.setInclude(t.include),t.fields&&0<Object.keys(t.fields).length)for(var n in t.fields){var r="fields["+n+"]="+t.fields[n].join(",");this.get_params.push(r)}},g.prototype.appendPath=function(e){""!==e&&this.paths.push(e)},g.prototype.getForCache=function(){return this.paths.join("/")+this.get_params.join("/")},g.prototype.get=function(){var e=this.get_params.slice();return 0<this.includes.length&&e.push("include="+this.includes.join(",")),this.paths.join("/")+(0<e.length?ee.injectedServices.rsJsonapiConfig.params_separator+e.join("&"):"")},g.prototype.setInclude=function(e){this.includes=e},g);function g(){this.paths=[],this.includes=[],this.get_params=[]}var y=(m.json_array2resources_array_by_type=function(e){var t={},n={};for(var r in m.json_array2resources_array(e,t),t){var i=t[r];i.type in n||(n[i.type]={}),n[i.type][i.id]=i}return n},m.json2resource=function(e,t){if(m.getService(e.type))return m.procreate(e);i.isDevMode()&&console.warn("`"+e.type+"`","service not found on json2resource().","Use @Autoregister() on service and inject it on component.");var n=new w;return n.id=e.id,n.type=e.type,n},m.getService=function(e){return ee.me.getResourceService(e)},m.getServiceOrFail=function(e){return ee.me.getResourceServiceOrFail(e)},m.buildIncluded=function(e){return"included"in e&&e.included?m.json_array2resources_array_by_type(e.included):{}},m.procreate=function(e){"type"in e&&"id"in e||console.error("Jsonapi Resource is not correct",e);var t=L.getInstance().getOrCreateResource(e.type,e.id);return t.fill({data:e}),t.is_new=!1,t},m.json_array2resources_array=function(e,t){void 0===t&&(t={});for(var n=0,r=e;n<r.length;n++){var i=r[n],o=m.json2resource(i,!1);t[o.type+"_"+o.id]=o}},m);function m(){}var b=(_.prototype.buildRelationships=function(){for(var e in this.relationships_from){var t=this.relationships_from[e];this.relationships_dest[e]&&null===t.data&&(this.relationships_dest[e].data=null,this.relationships_dest[e].builded=!0,this.relationships_dest[e].is_loading=!1,this.relationships_dest[e].loaded=!0),t.data&&(this.relationships_dest[e]instanceof E?this.__buildRelationshipHasMany(t,e):this.relationships_dest[e]instanceof T&&this.__buildRelationshipHasOne(t,e))}},_.prototype.__buildRelationshipHasMany=function(e,t){if(0===e.data.length)return this.relationships_dest[t]=new E,void(this.relationships_dest[t].builded=!0);this.relationships_dest[t].fill(e)},_.prototype.__buildRelationshipHasOne=function(e,t){if("type"in e.data){if(this.relationships_dest[t].data||(this.relationships_dest[t].data=new w),e.data.id!==this.relationships_dest[t].data.id&&(this.relationships_dest[t].data=new w,this.relationships_dest[t].data.type=e.data.type),this.relationships_dest[t].data.id!==e.data.id){var n=this.__buildRelationship(e.data);n?(this.relationships_dest[t].data=n,this.relationships_dest[t].builded=!0):(this.relationships_dest[t].data.id=e.data.id,this.relationships_dest[t].data.type=e.data.type)}}else this.relationships_dest[t].data=[]},_.prototype.__buildRelationship=function(e){if(e.type in this.included_resources&&e.id in this.included_resources[e.type]){var t=this.included_resources[e.type][e.id];return L.getInstance().setResource(t,!0),t}this.getService(e.type);var n=L.getInstance().getResource(e.type,e.id);if(n)return n},_);function _(e,t,n,r){this.getService=e,this.relationships_from=t,this.relationships_dest=n,this.included_resources=r}var w=(R.prototype.reset=function(){for(var e in this.id="",this.attributes={},this.is_new=!0,this.relationships)this.relationships[e]=this.relationships[e]instanceof E?new E:new T},R.prototype.toObject=function(e){e=Object.assign({},F.ParamsResource,e);var t,n={},r=[],i=[];for(var o in this.relationships){var s=this.relationships[o];if(s instanceof E){s.builded||s.data&&0!==s.data.length?n[o]={data:[]}:delete n[o];for(var a=0,c=s.data;a<c.length;a++){var u=c[a],d={id:u.id,type:u.type};n[o].data.push(d);var p=u.type+"_"+u.id;-1===i.indexOf(p)&&e.include&&-1!==e.include.indexOf(o)&&(i.push(p),r.push(u.toObject({}).data))}}else{if(null===s.data||void 0===s.data){n[o]={data:s.data};continue}s instanceof T||console.warn(s," is not DocumentCollection or DocumentResource");var l=s.data;if(s.data&&!("id"in s.data)&&0<Object.keys(s.data).length&&console.warn(o+" defined with hasMany:false, but I have a collection"),l.id&&l.type)n[o]={data:{id:l.id,type:l.type}};else if(!s.builded&&!l.id&&!l.type){delete n[o];continue}p=l.type+"_"+l.id,-1===i.indexOf(p)&&e.include&&-1!==e.include.indexOf(o)&&(i.push(p),r.push(l.toObject({}).data))}}this.getService()&&this.getService().parseToServer?(t=Object.assign({},this.attributes),this.getService().parseToServer(t)):t=this.attributes;var h={data:{type:this.type,id:this.id,attributes:t,relationships:n}};return this.meta&&(h.data.meta=this.meta),e.meta&&(h.meta=e.meta),0<r.length&&(h.included=r),h},R.prototype.fill=function(e){this.id=e.data.id||"",this.attributes=Object.assign({},this.attributes||{},e.data.attributes),this.is_new=!1;var t=y.getService(e.data.type);if(!this.relationships&&t&&(this.relationships=(new t.resource).relationships),!t)return!1;if(Object.keys(this.attributes).length){var n=y.getService(this.type);n&&"parseFromServer"in n&&n.parseFromServer(this.attributes)}return"cache_last_update"in e.data&&(this.cache_last_update=e.data.cache_last_update),new b(y.getService,e.data.relationships||{},this.relationships,y.buildIncluded(e)).buildRelationships(),!0},R.prototype.addRelationship=function(e,t){var n=this.relationships[t||e.type];n instanceof E?n.replaceOrAdd(e):n.data=e},R.prototype.addRelationships=function(e,t){var n=this;if(0!==e.length){if(!(this.relationships[t]instanceof E))throw new Error("addRelationships require a DocumentCollection (hasMany) relation.");e.forEach(function(e){n.addRelationship(e,t)})}},R.prototype.removeRelationship=function(e,t){if(!(e in this.relationships))return!1;if(!("data"in this.relationships[e]))return!1;var n=this.relationships[e];return n instanceof E?(n.data=n.data.filter(function(e){return e.id!==t}),0===n.data.length&&(n.builded=!0)):n.data=null,!0},R.prototype.hasManyRelated=function(e){return this.relationships[e]&&0<this.relationships[e].data.length},R.prototype.hasOneRelated=function(e){return Boolean(this.relationships[e]&&this.relationships[e].data.type&&""!==this.relationships[e].data.type)},R.prototype.restore=function(e){return void 0===e&&(e={}),e.meta=Object.assign({},e.meta,{restore:!0}),this.save(e)},R.prototype.getService=function(){return y.getServiceOrFail(this.type)},R.prototype.save=function(e){var t=this;if(e=Object.assign({},F.ParamsResource,e),this.is_saving||!this.loaded)return a.of({});this.is_saving=!0;var n=new a.Subject,r=this.toObject(e);""===this.id&&delete r.data.id;var i=new v;return i.applyParams(this.getService(),e),this.id&&i.appendPath(this.id),ee.exec(i.get(),this.id?"PATCH":"POST",r,!0).subscribe(function(e){t.is_saving=!1,t.id||(L.getInstance().deprecateCollections(i.get()),(new H).deprecateCollection(i.get())),"id"in e.data?(t.id=e.data.id,t.fill(e)):o.isArray(e.data)&&console.warn("Server return a collection when we save()",e.data),n.next(e),n.complete()},function(e){t.is_saving=!1,n.error("data"in e?e.data:e)}),n},R.prototype.setLoaded=function(e){this.is_loading=!e,this.loaded=e},R.prototype.setLoadedAndPropagate=function(e){this.setLoaded(e),h.propagateLoaded(this.relationships,e)},R.prototype.setSource=function(e){this.source=e},R.prototype.setSourceAndPropagate=function(e){for(var t in this.setSource(e),this.relationships){var n=this.relationships[t];n instanceof E&&n.setSource(e)}},R.prototype.setCacheLastUpdate=function(e){void 0===e&&(e=Date.now()),this.cache_last_update=e},R);function R(){this.id="",this.type="",this.attributes={},this.relationships={},this.links={},this.is_new=!0,this.is_saving=!1,this.is_loading=!1,this.loaded=!0,this.source="new",this.cache_last_update=0,this.ttl=0}function C(){this.builded=!1,this.is_loading=!0,this.loaded=!1,this.source="new",this.cache_last_update=0,this.meta={}}var S,O=(d(j,S=C),j.prototype.trackBy=function(e){return e.id},j.prototype.find=function(e){if("ids"===this.content)return null;for(var t=0;t<this.data.length;t++)if(this.data[t].id===e)return this.data[t];return null},j.prototype.fill=function(e){y.buildIncluded(e),this.page&&e.meta&&(this.page.number=e.meta.page||1,this.page.resources_per_page=e.meta.resources_per_page||null,this.page.size=e.meta.resources_per_page||null,this.page.total_resources=e.meta.total_resources||null);var t={};this.data.length=0,this.builded=e.data&&0===e.data.length;for(var n=0,r=e.data;n<r.length;n++){var i=r[n];try{var o=this.getResourceOrFail(i);o.fill({data:i}),t[i.id]=i.id,this.data.push(o),0<Object.keys(o.attributes).length&&(this.builded=!0)}catch(e){this.content="ids",this.builded=!1,this.data.push({id:i.id,type:i.type})}}for(var s=void 0;s<this.data.length;s++)this.data[s].id in t||delete this.data[s];this.meta=e.meta||{},"cache_last_update"in e&&(this.cache_last_update=e.cache_last_update)},j.prototype.getResourceOrFail=function(e){var t=this.find(e.id);if(null!==t)return t;var n=y.getService(e.type);if(!n)throw i.isDevMode()&&console.warn("The relationship relation_alias? (type "+e.type+") cant be generated because service for this type has not been injected."),new Error("Cant create service for "+e.type);return n.getOrCreateResource(e.id)},j.prototype.replaceOrAdd=function(e){var t=this.find(e.id);null===t?this.data.push(e):t=e},j.prototype.hasMorePages=function(){return!this.page.size||this.page.size<1?null:this.page.size*(this.page.number-1)+this.data.length<this.page.total_resources},j.prototype.setLoaded=function(e){this.is_loading=!e,this.loaded=e},j.prototype.setLoadedAndPropagate=function(t){this.setLoaded(t),"ids"!==this.content&&this.data.forEach(function(e){h.propagateLoaded(e.relationships,t)})},j.prototype.setBuilded=function(e){this.builded=e},j.prototype.setBuildedAndPropagate=function(t){this.setBuilded(t),"ids"!==this.content&&this.data.forEach(function(e){e.setLoaded(t)})},j.prototype.setSource=function(e){this.source=e},j.prototype.setSourceAndPropagate=function(t){this.setSource(t),this.data.forEach(function(e){e instanceof w&&e.setSource(t)})},j.prototype.setCacheLastUpdate=function(e){void 0===e&&(e=Date.now()),this.cache_last_update=e},j.prototype.setCacheLastUpdateAndPropagate=function(t){void 0===t&&(t=Date.now()),this.setCacheLastUpdate(t),this.data.forEach(function(e){e instanceof w&&e.setCacheLastUpdate(t)})},j.prototype.toObject=function(t){return this.builded?{data:this.data.map(function(e){return e.toObject(t).data})}:{data:this.data}},j);function j(){var e=S.apply(this,arguments)||this;return e.data=[],e.page=new l,e.ttl=0,e.content="ids",e}var P,E=(d(x,P=O),x);function x(){var e=P.apply(this,arguments)||this;return e.data=[],e.content="collection",e}var F=(A.newCollection=function(){return new E},A.isObjectLive=function(e,t){return 0<=e&&Date.now()<=t+1e3*e},A.forEach=function(t,n){Object.keys(t).forEach(function(e){n(t[e],e)})},A);function A(){}F.ParamsResource={beforepath:"",ttl:void 0,include:[],fields:{},id:""},F.ParamsCollection={beforepath:"",ttl:void 0,include:[],remotefilter:{},fields:{},smartfilter:{},sort:[],page:new l,store_cache_method:"individual",storage_ttl:0,cachehash:""};var L=(D.getInstance=function(){return D.instance||(D.instance=new D),D.instance},D.prototype.getResource=function(e,t){return this.getKey(e,t)in this.resources?this.resources[this.getKey(e,t)]:null},D.prototype.getResourceOrFail=function(e,t){if(this.getKey(e,t)in this.resources)return this.resources[this.getKey(e,t)];throw new Error("The requested resource does not exist in cache memory")},D.prototype.getKey=function(e,t){return e+"."+t},D.prototype.getOrCreateCollection=function(e){return e in this.collections||(this.collections[e]=new E,this.collections[e].source="new"),this.collections[e]},D.prototype.setCollection=function(e,t){e in this.collections||(this.collections[e]=new E);for(var n=0;n<t.data.length;n++){var r=t.data[n];this.setResource(r,!0)}this.collections[e].data=t.data,this.collections[e].page=t.page,this.collections[e].cache_last_update=t.cache_last_update},D.prototype.getOrCreateResource=function(e,t){var n=this.getResource(e,t);return null!==n||((n=y.getServiceOrFail(e).new()).id=t,this.setResource(n,!1)),n},D.prototype.setResource=function(e,t){void 0===t&&(t=!1),this.getKey(e.type,e.id)in this.resources?this.fillExistentResource(e):this.resources[this.getKey(e.type,e.id)]=e,this.resources[this.getKey(e.type,e.id)].cache_last_update=t?Date.now():0},D.prototype.deprecateCollections=function(e){for(var t in void 0===e&&(e=""),this.collections)t.includes(e)&&(this.collections[t].cache_last_update=0);return!0},D.prototype.removeResource=function(n,r){var e=this.getResource(n,r);if(e){for(var t in F.forEach(this.collections,function(e,t){e.data.splice(e.data.findIndex(function(e){return e.type===n&&e.id===r}),1)}),e.attributes={},e.relationships)null!==e.relationships[t].data&&void 0!==e.relationships[t].data&&(e.relationships[t].data instanceof Array?e.relationships[t].data=[]:e.relationships[t].data instanceof Object&&delete e.relationships[t].data);delete this.resources[this.getKey(n,r)]}},D.prototype.fillExistentResource=function(e){var t=this.getResourceOrFail(e.type,e.id);t.attributes=Object.assign({},t.attributes,e.attributes),t.relationships=t.relationships||e.relationships},D);function D(){this.resources={},this.collections={}}var I,T=(d(k,I=C),k.prototype.fill=function(e){this.builded=!1,this.content="id",null!==e?(this.data||(this.data=L.getInstance().getOrCreateResource(e.data.type,e.data.id)),this.data.fill(e)&&(this.builded=!0,this.content="resource"),this.meta=e.meta||{}):this.data=null},k.prototype.unsetData=function(){this.data=void 0,this.builded=!1},k);function k(){var e=I.apply(this,arguments)||this;return e.data=new w,e.builded=!1,e.content="id",e}var J=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}i((c=c.apply(o,s||[])).next())})},q=(M.prototype.getElement=function(n,r){return void 0===r&&(r="elements"),J(this,void 0,void 0,function(){var t;return p(this,function(e){switch(e.label){case 0:return[4,M.db.open()];case 1:return e.sent(),[4,M.db.table(r).get(n)];case 2:if(void 0===(t=e.sent()))throw new Error(n+" not found.");return[2,t]}})})},M.prototype.getElements=function(n,r){return void 0===r&&(r="elements"),J(this,void 0,void 0,function(){var t;return p(this,function(e){switch(e.label){case 0:return t={},[4,M.db.table(r).where(":id").anyOf(n).each(function(e){t[e.data.type+"."+e.data.id]=e})];case 1:return e.sent(),[2,n.map(function(e){return t[e]})]}})})},M.prototype.updateElements=function(n,e,r){return void 0===r&&(r="elements"),J(this,void 0,void 0,function(){var t=this;return p(this,function(e){return[2,M.db.open().then(function(){return J(t,void 0,void 0,function(){return p(this,function(e){return""===n?[2,M.db.table(r).clear()]:[2,M.db.table(r).where(":id").startsWith(n).delete().then(function(){})]})})})]})})},M.prototype.saveElements=function(r,i){return void 0===i&&(i="elements"),J(this,void 0,void 0,function(){var t,n;return p(this,function(e){return t=[],n=r.map(function(e){return t.push(e.key),e.content}),[2,M.db.open().then(function(){M.db.table(i).bulkPut(n,t)})]})})},M);function M(){M.db||(M.db=new n("dexie_data_provider")).version(1).stores({collections:"",elements:""})}var K=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}i((c=c.apply(o,s||[])).next())})};var H=(z.prototype.getResource=function(i,o){return void 0===o&&(o=[]),K(this,void 0,void 0,function(){var n,r,t;return p(this,function(e){switch(e.label){case 0:return[4,this.getDataResources([i])];case 1:if(void 0===(n=e.sent().shift()))throw new Error("Resource "+i+" don't found.");return 0===o.length?[2,n]:(r=[],o.forEach(function(e){if(!n||!n.data.relationships||!n.data.relationships[e])throw new Error("We dont have relation_alias on stored data resource");var t=n.data.relationships[e].data;t instanceof Array?t.forEach(function(e){r.push(z.getResourceKey(e))}):t&&"id"in t&&r.push(z.getResourceKey(t))}),[4,this.getDataResources(r)]);case 2:return t=e.sent(),[2,Object.assign({},n,{included:t.map(function(e){return e.data})})]}})})},z.prototype.getCollection=function(s,a){return void 0===a&&(a=[]),K(this,void 0,void 0,function(){var t,r,n,i,o;return p(this,function(e){switch(e.label){case 0:return[4,this.getDataCollection(s)];case 1:return t=e.sent(),[4,this.getDataResources(t.keys)];case 2:return r=e.sent(),n={data:r.map(function(e){return e.data}),cache_last_update:t.updated_at},0===a.length?[2,n]:(i=[],a.forEach(function(n){r.forEach(function(e){if(e.data.relationships&&e.data.relationships[n]){var t=e.data.relationships[n].data;t instanceof Array?t.forEach(function(e){i.push(z.getResourceKey(e))}):"id"in t&&i.push(z.getResourceKey(t))}})}),[4,this.getDataResources(i)]);case 3:return o=e.sent(),[2,Object.assign({},n,{included:o.map(function(e){return e.data})})]}})})},z.prototype.getDataCollection=function(t){return K(this,void 0,void 0,function(){return p(this,function(e){return[2,this.dataProvider.getElement(t,"collections")]})})},z.prototype.getDataResources=function(t){return K(this,void 0,void 0,function(){return p(this,function(e){return[2,this.dataProvider.getElements(t,"elements")]})})},z.prototype.saveCollection=function(e,t,n){void 0===n&&(n=[]),this.dataProvider.saveElements(z.collectionToElement(e,t),"collections"),this.dataProvider.saveElements(z.collectionResourcesToElements(t,n),"elements")},z.prototype.saveResource=function(t,n){return void 0===n&&(n=[]),K(this,void 0,void 0,function(){return p(this,function(e){return[2,this.dataProvider.saveElements(z.toResourceElements(z.getResourceKey(t),t,n),"elements")]})})},z.collectionToElement=function(e,t){var n={key:e,content:{updated_at:Date.now(),keys:[]}};return t.data.forEach(function(e){var t=z.getResourceKey(e);n.content.keys.push(t)}),[n]},z.collectionResourcesToElements=function(e,n){void 0===n&&(n=[]);var r=[];return e.data.forEach(function(e){var t=z.getResourceKey(e);r.push.apply(r,z.toResourceElements(t,e,n))}),r},z.toResourceElements=function(e,n,t){void 0===t&&(t=[]);var r=[{key:e,content:n.toObject()}];return r[0].content.data.cache_last_update=Date.now(),t.forEach(function(e){var t=n.relationships[e];if(t instanceof E)t.data.forEach(function(e){r.push(z.getElement(e))});else if(t instanceof T){if(null===t.data||void 0===t.data)return;r.push(z.getElement(t.data))}}),r},z.getResourceKey=function(e){return e.type+"."+e.id},z.getElement=function(e){return{key:z.getResourceKey(e),content:e.toObject()}},z.prototype.deprecateCollection=function(t){return K(this,void 0,void 0,function(){return p(this,function(e){return[2,this.dataProvider.updateElements(t,{},"collections")]})})},z);function z(){this.dataProvider=new q}function B(e,t){var n=t&&"number"==typeof t?t:e.ttl||0;return Date.now()<e.cache_last_update+1e3*n}function G(e,t,n){var r=n.value;return n.value=function(){var e,t=Array.prototype.slice.call(arguments);try{e="string"==typeof t[0]?t[0]:t[0].type}catch(e){return console.warn("ERROR: First argument of methods decorated with serviceIsRegistered has to be string or Resource."),null}return ee.me.getResourceService(e)?r.apply(this,t):(console.warn("ERROR: "+e+" service has not been registered."),null)},n}var U=function(){this.url="http://yourdomain/api/v1/",this.params_separator="?",this.unify_concurrency=!0,this.cache_prerequests=!0,this.cachestore_support=!0,this.parameters={page:{number:"page[number]",size:"page[size]"}}},W=(N.prototype.exec=function(e,t,n){var r=this,i={body:n||null,headers:new s.HttpHeaders({"Content-Type":"application/vnd.api+json",Accept:"application/vnd.api+json"})};if("get"!==t)return this.http.request(t,this.rsJsonapiConfig.url+e,i).pipe(c.tap(function(){delete r.get_requests[e]}),c.share());if(this.get_requests[e])return this.get_requests[e];var o=this.http.request(t,this.rsJsonapiConfig.url+e,i).pipe(c.tap(function(){delete r.get_requests[e]}),c.share());return this.get_requests[e]=o},N);function N(e,t){this.http=e,this.rsJsonapiConfig=t,this.get_requests={}}W.decorators=[{type:i.Injectable}],W.ctorParameters=function(){return[{type:s.HttpClient},{type:U}]};var V=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}i((c=c.apply(o,s||[])).next())})};var Q=(X.prototype.getDataObject=function(r,i){return V(this,void 0,void 0,function(){var t,n;return p(this,function(e){switch(e.label){case 0:return t="collection"===r?"collections":"elements",[4,this.db.open()];case 1:return e.sent(),[4,this.db.table(t).get(r+"."+i)];case 2:if(void 0===(n=e.sent()))throw new Error;return[2,n]}})})},X.prototype.getDataResources=function(r){return V(this,void 0,void 0,function(){var t,n;return p(this,function(e){switch(e.label){case 0:return t=this.db.table("elements").where(":id").anyOf(r),n={},[4,t.each(function(e){n[e.id]=e})];case 1:return e.sent(),[2,n]}})})},X.prototype.saveResource=function(t,n,e){var r=this,i=Object.assign({cache_last_update:Date.now()},e);this.db.open().then(function(){return V(r,void 0,void 0,function(){return p(this,function(e){return[2,this.db.table("elements").put(i,t+"."+n)]})})})},X.prototype.saveCollection=function(t,e){var n=this,r=Object.assign({cache_last_update:Date.now()},e);this.db.open().then(function(){return V(n,void 0,void 0,function(){return p(this,function(e){return[2,this.db.table("collections").put(r,"collection."+t)]})})})},X.prototype.clearCache=function(){var e=this;this.db.open().then(function(){return V(e,void 0,void 0,function(){return p(this,function(e){return[2,this.db.table("elements").toCollection().delete()]})})}),this.db.open().then(function(){return V(e,void 0,void 0,function(){return p(this,function(e){return[2,this.db.table("collections").toCollection().delete()]})})})},X.prototype.deprecateResource=function(t,n){var e=this;this.db.open().then(function(){return V(e,void 0,void 0,function(){return p(this,function(e){return[2,this.db.table("elements").where(":id").startsWith(t+"."+n).modify({cache_last_update:0})]})})})},X.prototype.deprecateCollection=function(t){var e=this;this.db.open().then(function(){return V(e,void 0,void 0,function(){return p(this,function(e){return[2,this.db.table("collections").where(":id").startsWith(t).modify({cache_last_update:0})]})})})},X.prototype.removeObjectsWithKey=function(e){return V(this,void 0,void 0,function(){return p(this,function(e){return[2]})})},X.prototype.checkIfIsTimeToClean=function(){},X.prototype.checkAndDeleteOldElements=function(){},X);function X(){this.db=new n("jsonapi_db"),this.db.version(1).stores({collections:"",elements:""}),this.checkIfIsTimeToClean()}var Y=function(e,t,n,r){var i,o=arguments.length,s=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;0<=a;a--)(i=e[a])&&(s=(o<3?i(s):3<o?i(t,n,s):i(t,n))||s);return 3<o&&s&&Object.defineProperty(t,n,s),s},Z=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},$=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}i((c=c.apply(o,s||[])).next())})},ee=(te.delete=function(e){return te.exec(e,"DELETE")},te.get=function(e){return te.exec(e,"get")},te.exec=function(e,t,n,r){return void 0===r&&(r=!0),te.me.refreshLoadings(1),te.injectedServices.JsonapiHttp.exec(e,t,n).pipe(c.tap(function(){return te.me.refreshLoadings(-1)}),c.catchError(function(e){return e=e.error||e,te.me.refreshLoadings(-1),e.status<=0?!te.me.loadingsOffline(e)&&i.isDevMode()&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsOffline for catch it) error =>",e):r&&!te.me.loadingsError(e)&&i.isDevMode()&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsError for catch it) error =>",e),a.throwError(e)}))},te.prototype.registerService=function(e){return!(e.type in this.resourceServices)&&(this.resourceServices[e.type]=e)},te.prototype.getResourceService=function(e){return this.resourceServices[e]},te.prototype.getResourceServiceOrFail=function(e){var t=this.resourceServices[e];if(!t)throw new Error("The requested service with type "+e+" has not been registered, please use register() method or @Autoregister() decorator");return t},te.removeCachedResource=function(e,t){L.getInstance().removeResource(e,t)},te.setCachedResource=function(e){L.getInstance().setResource(e,!0)},te.deprecateCachedCollections=function(e){var t=te.me.getResourceServiceOrFail(e),n=new v;n.applyParams(t),L.getInstance().deprecateCollections(n.getForCache())},te.prototype.refreshLoadings=function(e){this.loadingsCounter+=e,0===this.loadingsCounter?this.loadingsDone():1===this.loadingsCounter&&this.loadingsStart()},te.prototype.clearCache=function(){return $(this,void 0,void 0,function(){return p(this,function(e){return te.injectedServices.JsonapiStoreService.clearCache(),L.getInstance().deprecateCollections(""),[2,(new H).deprecateCollection("").then(function(){return!0})]})})},te.prototype.duplicateResource=function(n){for(var r=this,i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];var o=this.getResourceServiceOrFail(n.type).new();function t(t){var e=n.relationships[t];if(!e.data)return o.relationships[t]=n.relationships[t],"continue";"id"in e.data?-1<i.indexOf(t)?o.addRelationship(s.duplicateResource(e.data),t):o.addRelationship(e.data,t):-1<i.indexOf(t)?e.data.forEach(function(e){o.addRelationship(r.duplicateResource(e),t)}):o.addRelationships(e.data,t)}o.id="new_"+Math.floor(1e4*Math.random()).toString(),o.attributes=Object.assign({},o.attributes,n.attributes);var s=this;for(var a in n.relationships)t(a);return o},te);function te(e,t,n){for(var r in this.loadingsCounter=0,this.loadingsStart=u.noop,this.loadingsDone=u.noop,this.loadingsError=u.noop,this.loadingsOffline=u.noop,this.resourceServices={},this.config=new U,this.config)this.config[r]=void 0!==e[r]?e[r]:this.config[r];te.me=this,te.injectedServices={JsonapiStoreService:t,JsonapiHttp:n,rsJsonapiConfig:this.config}}ee.decorators=[{type:i.Injectable}],ee.ctorParameters=function(){return[{type:U,decorators:[{type:i.Optional}]},{type:Q},{type:W}]},Y([G,Z("design:type",Function),Z("design:paramtypes",[String,String]),Z("design:returntype",void 0)],ee,"removeCachedResource",null),Y([G,Z("design:type",Function),Z("design:paramtypes",[w]),Z("design:returntype",void 0)],ee,"setCachedResource",null),Y([G,Z("design:type",Function),Z("design:paramtypes",[String]),Z("design:returntype",void 0)],ee,"deprecateCachedCollections",null);var ne=(re.forRoot=function(e){return{ngModule:re,providers:[{provide:U,useValue:e}]}},re);function re(e,t){if(e)throw new Error("NgxJsonapiModule is already loaded. Import it in the AppModule only")}ne.decorators=[{type:i.NgModule,args:[{imports:[t.CommonModule],exports:[s.HttpClientModule],providers:[ee,Q,U,W]}]}],ne.ctorParameters=function(){return[{type:ne,decorators:[{type:i.Optional},{type:i.SkipSelf}]},{type:ee}]};var ie=(oe.prototype.toparams=function(e){var n=this,r="";return F.forEach(e,function(e,t){r+=n.toparamsarray(e,"&"+t)}),r.slice(1)},oe.prototype.toparamsarray=function(e,n){var r=this,i="";return Array.isArray(e)||o.isObject(e)?F.forEach(e,function(e,t){i+=r.toparamsarray(e,n+"["+t+"]")}):i+=n+"="+e,i},oe);function oe(){}var se,ae=(d(ce,se=v),ce.prototype.applyParams=function(e,t){void 0===t&&(t={}),se.prototype.applyParams.call(this,e,t);var n=new ie;t.remotefilter&&0<Object.keys(t.remotefilter).length&&(e.parseToServer&&e.parseToServer(t.remotefilter),this.addParam(n.toparams({filter:t.remotefilter}))),t.page&&(1<t.page.number&&this.addParam(this.getPageConfig().number+"="+t.page.number),t.page.size&&this.addParam(this.getPageConfig().size+"="+t.page.size)),t.sort&&t.sort.length&&this.addParam("sort="+t.sort.join(","))},ce.prototype.getPageConfig=function(){return ee.injectedServices.rsJsonapiConfig.parameters&&ee.injectedServices.rsJsonapiConfig.parameters.page||{number:"number",size:"size"}},ce.prototype.addParam=function(e){this.get_params.push(e)},ce);function ce(){return null!==se&&se.apply(this,arguments)||this}var ue=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}i((c=c.apply(o,s||[])).next())})},de=(pe.prototype.register=function(){if(null===ee.me)throw new Error("Error: you are trying register `"+this.type+"` before inject JsonapiCore somewhere, almost one time.");return ee.me.registerService(this)},pe.prototype.newResource=function(){return this.new()},pe.prototype.newCollection=function(){return new E},pe.prototype.new=function(){var e=new this.resource;return e.type=this.type,this.getService(),e.reset(),e},pe.prototype.getPrePath=function(){return""},pe.prototype.getPath=function(){return this.path||this.type},pe.prototype.get=function(e,t){var n=this;void 0===t&&(t={}),t=Object.assign({},F.ParamsResource,t);var r=new v;r.applyParams(this,t),r.appendPath(e);var i=this.getOrCreateResource(e);i.setLoaded(!1);var o=new a.BehaviorSubject(i);return 0<Object.keys(t.fields||[]).length?this.getGetFromServer(r,i,o):B(i,t.ttl)&&function(e,t){if(0===t.length)return!0;for(var n in e.relationships)if(t.includes(n)&&!e.relationships[n].builded)return!1;return!0}(i,t.include||[])?(i.setLoaded(!0),setTimeout(function(){return o.complete()},0)):0===i.cache_last_update?this.getGetFromLocal(t,r,i).then(function(){o.next(i),setTimeout(function(){return o.complete()},0)}).catch(function(){i.setLoaded(!1),n.getGetFromServer(r,i,o)}):this.getGetFromServer(r,i,o),o.asObservable()},pe.prototype.getGetFromLocal=function(n,r,i){return void 0===n&&(n={}),ue(this,void 0,void 0,function(){var t;return p(this,function(e){switch(e.label){case 0:if(!ee.injectedServices.rsJsonapiConfig.cachestore_support)throw new Error("We cant handle this request");return i.setLoaded(!1),[4,(new H).getResource(H.getResourceKey(i),r.includes)];case 1:if(t=e.sent(),i.fill(t),i.setSource("store"),B(i,n.ttl))return i.setLoadedAndPropagate(!0),[2];throw new Error("Resource is dead!")}})})},pe.prototype.getGetFromServer=function(t,n,r){ee.get(t.get()).subscribe(function(e){n.fill(e),n.cache_last_update=Date.now(),n.setLoadedAndPropagate(!0),n.setSourceAndPropagate("server"),ee.injectedServices.rsJsonapiConfig.cachestore_support&&(new H).saveResource(n,t.includes),r.next(n),setTimeout(function(){return r.complete()},0)},function(e){n.setLoadedAndPropagate(!0),r.next(n),r.error(e)})},pe.prototype.getService=function(){return y.getService(this.type)||this.register()},pe.prototype.getOrCreateCollection=function(e){var t=this.getService(),n=L.getInstance().getOrCreateCollection(e.getForCache());return n.ttl=t.collections_ttl,"new"!==n.source&&(n.source="memory"),n},pe.prototype.getOrCreateResource=function(e){var t,n=y.getServiceOrFail(this.type);return null===(t=L.getInstance().getResource(this.type,e))&&((t=n.new()).id=e,L.getInstance().setResource(t,!1)),"new"!==t.source&&(t.source="memory"),t},pe.prototype.createResource=function(e){var t=y.getServiceOrFail(this.type).new();return t.id=e,L.getInstance().setResource(t,!1),t},pe.prototype.clearCacheMemory=function(){return ue(this,void 0,void 0,function(){return p(this,function(e){return[2,this.clearCache()]})})},pe.prototype.clearCache=function(){return ue(this,void 0,void 0,function(){var t;return p(this,function(e){return(t=new v).applyParams(this),L.getInstance().deprecateCollections(t.getForCache()),[2,(new H).deprecateCollection(t.getForCache()).then(function(){return!0})]})})},pe.prototype.parseToServer=function(e){},pe.prototype.parseFromServer=function(e){},pe.prototype.delete=function(t,e){var n=this;e=Object.assign({},F.ParamsResource,e);var r=new v;r.applyParams(this,e),r.appendPath(t);var i=new a.Subject;return ee.delete(r.get()).subscribe(function(e){L.getInstance().removeResource(n.type,t),i.next(),i.complete()},function(e){i.error(e)}),i.asObservable()},pe.prototype.all=function(e){var t=this;void 0===e&&(e={});var n=Object.assign({},F.ParamsCollection,e);n.ttl||0===n.ttl||(n.ttl=this.collections_ttl);var r=new ae;r.applyParams(this,n);var i=this.getOrCreateCollection(r);i.page.number=1*n.page.number;var o=new a.BehaviorSubject(i);return 0<Object.keys(n.fields).length?this.getAllFromServer(r,n,i,o):B(i,n.ttl)?setTimeout(function(){return o.complete()},0):0===i.cache_last_update?(i.source="new",this.getAllFromLocal(n,r,i).then(function(){o.next(i),setTimeout(function(){o.complete()},0)}).catch(function(){i.setLoaded(!1),t.getAllFromServer(r,n,i,o)})):this.getAllFromServer(r,n,i,o),o.asObservable()},pe.prototype.getAllFromLocal=function(n,r,i){return void 0===n&&(n={}),ue(this,void 0,void 0,function(){var t;return p(this,function(e){switch(e.label){case 0:if(!ee.injectedServices.rsJsonapiConfig.cachestore_support)throw new Error("We cant handle this request");return i.setLoaded(!1),"compact"!==n.store_cache_method?[3,2]:[4,ee.injectedServices.JsonapiStoreService.getDataObject("collection",r.getForCache()+".compact")];case 1:return t=e.sent(),[3,4];case 2:return[4,(new H).getCollection(r.getForCache(),r.includes)];case 3:t=e.sent(),e.label=4;case 4:if(i.fill(t),i.setSourceAndPropagate("store"),B(i,n.ttl))return i.setLoadedAndPropagate(!0),i.setBuildedAndPropagate(!0),[2];throw new Error("Collection is dead!")}})})},pe.prototype.getAllFromServer=function(r,i,o,s){o.setLoaded(!1),ee.get(r.get()).subscribe(function(e){if(i.cachehash)for(var t in e.data){var n=e.data[t];n.id=n.id+i.cachehash}o.fill(e),o.cache_last_update=Date.now(),o.setCacheLastUpdateAndPropagate(),o.setSourceAndPropagate("server"),o.setLoadedAndPropagate(!0),(new H).saveCollection(r.getForCache(),o,r.includes),ee.injectedServices.rsJsonapiConfig.cachestore_support&&"compact"===i.store_cache_method&&ee.injectedServices.JsonapiStoreService.saveCollection(r.getForCache()+".compact",e),s.next(o),setTimeout(function(){return s.complete()},0)},function(e){o.setLoadedAndPropagate(!0),s.next(o),s.error(e)})},pe);function pe(){this.resource=w}e.Autoregister=function(){return function(e){function t(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];function n(){return i.apply(this,arguments)}n.prototype=Object.create(i.prototype);var r=new(n.bind.apply(n,[void 0].concat(e)));return r.register(),r}var i=e;return t.prototype=Object.create(e.prototype),t}},e.JsonapiCore=ee,e.Resource=w,e.DocumentResource=T,e.DocumentCollection=E,e.Service=de,e.NgxJsonapiModule=ne,e.ɵe=C,e.ɵa=O,e.ɵb=U,e.ɵd=W,e.ɵc=Q,Object.defineProperty(e,"__esModule",{value:!0})});